# Bug Report: UnobservedFiles Not Properly Excluding Goflare Output Files

## Status
**PENDING APPROVAL** - Requires approval before refactoring

## Problem Statement

When running `golite` in manual mode (e.g., `golite/example` directory), the file watcher is incorrectly processing output files generated by `goflare` (edge worker deployment handler). Specifically:

**Symptom:**
- The file `deploy/edgeworker/_worker.js` (goflare output) is being detected as a source file
- Its content is being included in `src/web/public/main.js` by the assetmin handler
- This creates unwanted duplication and incorrect bundling

**Evidence from logs:**
```bash
19:01:45  ASSETS  .js create ... /home/cesar/Dev/Pkg/Mine/golite/example/src/web/ui/js/wasm_exec.js
19:01:45  ASSETS  .js create ... /home/cesar/Dev/Pkg/Mine/golite/example/src/web/ui/main.js  
```

The assetmin handler should **NOT** process `deploy/edgeworker/_worker.js` because it's an output file, not a source file.

---

## Root Cause Analysis

### 1. **Path Type Inconsistency (Absolute vs Relative)**

**Location:** `goflare/events.go:28-33`

```go
func (h *Goflare) UnobservedFiles() []string {
	return []string{
		h.tw.OutputRelativePath(),        // ✅ Returns RELATIVE: "deploy/edgeworker/app.wasm"
		h.tw.WasmExecJsOutputPath(),     // ❌ Returns ABSOLUTE: "/full/path/deploy/edgeworker/wasm_exec.js"
	}
}
```

**Problem:** The two methods return **different path types**:

1. **`OutputRelativePath()`** (`tinywasm/builderInit.go:92-94`)
   - Returns: `w.activeBuilder.FinalOutputPath()`
   - Which is: `filepath.Join(OutFolderRelativePath, OutName+Extension)`
   - **Result:** `"deploy/edgeworker/app.wasm"` (RELATIVE ✅)

2. **`WasmExecJsOutputPath()`** (`tinywasm/javascripts.go:42-44`)
   - Returns: `path.Join(w.Config.AppRootDir, w.Config.WasmExecJsOutputDir, "wasm_exec.js")`
   - **Result:** `"/home/cesar/Dev/Pkg/Mine/golite/example/deploy/edgeworker/wasm_exec.js"` (ABSOLUTE ❌)

**Actual output from test:**
```
WasmExecJsOutputPath(): /home/cesar/Dev/Pkg/Mine/golite/example/deploy/edgeworker/wasm_exec.js
OutputRelativePath(): deploy/edgeworker/app.wasm
```

**Impact:** 
- `devwatch.Contain()` expects consistent path types for matching
- Mixing absolute and relative paths causes unpredictable matching behavior
- The absolute path may fail to match against the normalized relative paths used during file scanning

---

### 2. **Missing Critical Output File: `_worker.js`**

**Critical finding:** The main output file `_worker.js` is **completely missing** from the `UnobservedFiles()` return value.

**Generation location:** `goflare/javascripts.go:9-11`
```go
func (g *Goflare) generateWorkerFile() error {
	destPath := filepath.Join(g.tw.WasmExecJsOutputDir, "_worker.js")
	// ... generates _worker.js with embedded wasm_exec.js content
}
```

**What's actually generated:**
- `deploy/edgeworker/_worker.js` - **Main worker file** (THIS IS THE CULPRIT)
- `deploy/edgeworker/app.wasm` - WASM binary

**What's in UnobservedFiles:**
- ❌ Missing: `_worker.js`
- ✅ Present: `app.wasm` (via `OutputRelativePath()`)
- ⚠️ Present: `wasm_exec.js` (but this file is **never created** due to `DisableWasmExecJsOutput = true`)

**The Core Issue:**
`_worker.js` contains JavaScript code and is detected by assetmin's `.js` file watcher, causing it to be bundled into `src/web/public/main.js`.

---

### 3. **Phantom File Reference: `wasm_exec.js`**

**Configuration detail:** In `goflare/goflare.go:90-101`:
```go
tw := tinywasm.New(&tinywasm.Config{
	AppRootDir:              c.AppRootDir,
	SourceDir:               c.RelativeInputDirectory,
	OutputDir:               c.RelativeOutputDirectory,
	WasmExecJsOutputDir:     c.RelativeOutputDirectory,   // "deploy/edgeworker"
	MainInputFile:           c.MainInputFile,
	OutputName:              outputName,
	DisableWasmExecJsOutput: true,  // ⚠️ wasm_exec.js is NOT written!
	// ...
})
```

**The Phantom File Problem:**
- `UnobservedFiles()` includes `h.tw.WasmExecJsOutputPath()` 
- This would resolve to: `/home/.../deploy/edgeworker/wasm_exec.js`
- **BUT** this file is **never created** because `DisableWasmExecJsOutput = true`
- The wasm_exec.js content is embedded **inline** in `_worker.js` instead

**Why this doesn't help:**
1. The file doesn't exist, so ignoring it has no effect
2. The path is absolute (doesn't match devwatch's relative path logic)
3. The real problem file (`_worker.js`) is not in the list

---

### 4. **Summary of Path Issues**

| File | Should Be Ignored? | Currently in UnobservedFiles? | Path Type | Actually Created? |
|------|-------------------|-------------------------------|-----------|-------------------|
| `deploy/edgeworker/_worker.js` | ✅ YES | ❌ NO | - | ✅ YES |
| `deploy/edgeworker/app.wasm` | ✅ YES | ✅ YES | Relative | ✅ YES |
| `deploy/edgeworker/wasm_exec.js` | N/A | ✅ YES | Absolute | ❌ NO (embedded in _worker.js) |

**The Critical Gap:** `_worker.js` is created but not ignored, causing it to be processed by assetmin.

---

## Affected Components

### Component: `goflare`
- **File:** `goflare/events.go`
- **Method:** `UnobservedFiles()`
- **Issue:** Calls non-existent method and doesn't include `_worker.js`

### Component: `tinywasm`
- **Impact:** Indirect - missing method referenced by goflare
- **Note:** TinyWasm is working correctly; the issue is in how goflare uses it

### Component: `devwatch`
- **File:** `devwatch/InitialRegistration.go`
- **Impact:** Receives incomplete unobserved file list from goflare
- **Result:** Doesn't filter `_worker.js` during initial file scan

### Component: `assetmin`
- **Impact:** Processes `_worker.js` as a valid source file
- **Result:** Includes its content in `main.js` output

---

## Reproduction Steps

1. Navigate to `golite/example` directory
2. Ensure project structure matches example (with `deploy/edgeworker/` directory)
3. Run `golite` in manual mode
4. Observe file watcher initialization logs
5. **Expected:** `_worker.js` should be ignored
6. **Actual:** `_worker.js` content is included in `main.js`

---

## Proposed Solution

### Option 1: Complete Fix with Consistent Relative Paths (Recommended)

**Fix `goflare/events.go`:**
```go
func (h *Goflare) UnobservedFiles() []string {
	return []string{
		// WASM output file (RELATIVE path)
		filepath.Join(h.config.RelativeOutputDirectory, h.config.OutputWasmFileName),
		
		// Worker file (RELATIVE path) - THE MISSING FILE
		filepath.Join(h.config.RelativeOutputDirectory, "_worker.js"),
	}
}
```

**Reasoning:**
- ✅ Uses goflare's own configuration values (self-contained)
- ✅ Returns **consistent RELATIVE paths** (matches devwatch expectations)
- ✅ Explicitly includes `_worker.js` (the main culprit)
- ✅ Removes phantom `wasm_exec.js` reference (file doesn't exist)
- ✅ No dependency on tinywasm methods with mixed path types
- ✅ Clear and self-documenting

**Expected output for golite/example:**
```go
[]string{
	"deploy/edgeworker/app.wasm",      // Relative path
	"deploy/edgeworker/_worker.js",    // Relative path - NOW INCLUDED!
}
```

**Why relative paths?**
- `devwatch.Contain()` normalizes paths and can match both full paths and path components
- During `filepath.Walk()`, paths are absolute but are checked against relative patterns
- Relative paths like `"deploy/edgeworker/_worker.js"` will match when the walker encounters `/full/path/deploy/edgeworker/_worker.js`

---

### Option 2: Fix Path Type Inconsistency in TinyWasm

**Modify `tinywasm/javascripts.go`:**
```go
// WasmExecJsOutputPath returns the RELATIVE output path for wasm_exec.js
func (w *TinyWasm) WasmExecJsOutputPath() string {
	// Return relative path instead of absolute
	return path.Join(w.Config.WasmExecJsOutputDir, "wasm_exec.js")
}
```

**Then update `goflare/events.go`:**
```go
func (h *Goflare) UnobservedFiles() []string {
	return []string{
		h.tw.OutputRelativePath(),        // Already returns relative path ✅
		h.tw.WasmExecJsOutputPath(),     // Now returns relative path ✅
		filepath.Join(h.config.RelativeOutputDirectory, "_worker.js"), // Add missing file ✅
	}
}
```

**Reasoning:**
- ✅ Fixes path type inconsistency at the source (tinywasm)
- ✅ Makes `WasmExecJsOutputPath()` consistent with `OutputRelativePath()`
- ✅ Benefits other potential users of tinywasm
- ⚠️ Breaking change if other code depends on absolute path from `WasmExecJsOutputPath()`

**Trade-offs:**
- Requires changes to tinywasm package
- Need to verify no other code depends on absolute path behavior
- More complex implementation affecting multiple packages

---

### Option 3: Hybrid Approach (Use TinyWasm + Add Missing File)

**Keep current `goflare/events.go` structure but fix issues:**
```go
func (h *Goflare) UnobservedFiles() []string {
	return []string{
		h.tw.OutputRelativePath(),                           // Relative ✅
		filepath.Join(h.config.RelativeOutputDirectory, "_worker.js"), // Add missing file ✅
		// Remove h.tw.WasmExecJsOutputPath() - phantom file with wrong path type
	}
}
```

**Reasoning:**
- ✅ Uses existing `OutputRelativePath()` (it works correctly)
- ✅ Adds missing `_worker.js` 
- ✅ Removes phantom `wasm_exec.js` reference
- ✅ Minimal changes to goflare only
- ✅ No breaking changes to tinywasm

---

### Option 4: Enhanced Logging for Debugging

**Before implementing fix, add logging to verify paths:**

```go
func (h *Goflare) UnobservedFiles() []string {
	unobserved := []string{
		filepath.Join(h.config.RelativeOutputDirectory, h.config.OutputWasmFileName),
		filepath.Join(h.config.RelativeOutputDirectory, "_worker.js"),
	}
	
	// Temporary debug logging
	if h.config.Logger != nil {
		h.config.Logger("GOFLARE UnobservedFiles:", unobserved)
	}
	
	return unobserved
}
```

**In `devwatch/InitialRegistration.go`, add logging:**
```go
func (h *DevWatch) InitialRegistration() {
	h.Logger("Registration APP ROOT DIR: " + h.AppRootDir)
	
	// ... existing code ...
	
	// Load unobserved files from each FilesEventHandler
	for _, handler := range h.FilesEventHandlers {
		files := handler.UnobservedFiles()
		h.Logger("DEBUG: Handler unobserved files:", files)  // 🔍 NEW
		for _, file := range files {
			h.no_add_to_watch[file] = true
		}
	}
	// ...
}
```

---

## Testing Plan

### Unit Tests

**1. Test goflare.UnobservedFiles() output:**

File: `goflare/events_test.go` (new file)
```go
func TestGoflareUnobservedFiles(t *testing.T) {
	config := &Config{
		AppRootDir:              "/test/project",
		RelativeInputDirectory:  "src/cmd/edgeworker",
		RelativeOutputDirectory: "deploy/edgeworker",
		MainInputFile:           "main.go",
		OutputWasmFileName:      "app.wasm",
		Logger:                  func(msg ...any) { t.Log(msg...) },
	}
	
	goflare := New(config)
	unobserved := goflare.UnobservedFiles()
	
	expected := []string{
		"deploy/edgeworker/app.wasm",
		"deploy/edgeworker/_worker.js",
	}
	
	assert.ElementsMatch(t, expected, unobserved)
}
```

**2. Integration test with devwatch:**

File: `golite/section-deploy_test.go` (new file)
```go
func TestDeployUnobservedFilesIntegration(t *testing.T) {
	// Setup test directory structure
	tmp := t.TempDir()
	
	// Create golite handler with deploy section
	h := &handler{rootDir: tmp}
	h.config = NewConfig(tmp, func(msg ...any) { t.Log(msg...) })
	
	// Initialize deploy section (creates goflare)
	h.AddSectionDEPLOY()
	
	// Verify unobserved files from goflare
	unobserved := h.deployCloudflare.UnobservedFiles()
	
	// Should contain both wasm and worker files
	assert.Contains(t, unobserved, "deploy/edgeworker/app.wasm")
	assert.Contains(t, unobserved, "deploy/edgeworker/_worker.js")
	
	// Verify these paths are relative (not absolute)
	for _, path := range unobserved {
		assert.False(t, filepath.IsAbs(path), "Path should be relative: %s", path)
	}
}
```

**3. Test devwatch doesn't process _worker.js:**

File: `golite/watcher_integration_test.go` (new file)
```go
func TestWatcherIgnoresGoflareOutputFiles(t *testing.T) {
	// Create temp project structure
	tmp := t.TempDir()
	
	// Create deploy directory and _worker.js
	deployDir := filepath.Join(tmp, "deploy", "edgeworker")
	os.MkdirAll(deployDir, 0755)
	workerFile := filepath.Join(deployDir, "_worker.js")
	os.WriteFile(workerFile, []byte("export default { fetch() {} }"), 0644)
	
	// Track assetmin events
	var processedFiles []string
	
	// Setup golite with monitoring
	// ... (initialize handlers with custom logger)
	
	// Trigger initial registration
	h.watcher.InitialRegistration()
	
	// Verify _worker.js was NOT processed
	assert.NotContains(t, processedFiles, "_worker.js")
}
```

---

### Manual Testing

**Before fix:**
1. Run `golite` in `golite/example`
2. Check logs for: `ASSETS  .js create ... deploy/edgeworker/_worker.js`
3. Inspect `src/web/public/main.js` - should contain worker code (BUG)

**After fix:**
1. Apply recommended solution (Option 1)
2. Run `golite` in `golite/example`
3. Verify logs show: `GOFLARE UnobservedFiles: [deploy/edgeworker/app.wasm deploy/edgeworker/_worker.js]`
4. Verify NO log for: `ASSETS  .js create ... deploy/edgeworker/_worker.js`
5. Inspect `src/web/public/main.js` - should NOT contain worker code (FIXED)

---

## Implementation Checklist

### Phase 1: Investigation & Logging (CURRENT)
- [x] Document the problem
- [ ] Add debug logging to verify current behavior
- [ ] Reproduce issue in controlled environment
- [ ] Confirm root cause with logs

### Phase 2: Core Fix
- [ ] Implement Option 1 (recommended) in `goflare/events.go`
- [ ] Remove or comment out debug logging
- [ ] Verify compilation succeeds
- [ ] Run manual tests in `golite/example`

### Phase 3: Testing
- [ ] Create unit test: `goflare/events_test.go`
- [ ] Create integration test: `golite/section-deploy_test.go`
- [ ] Create watcher test: `golite/watcher_integration_test.go`
- [ ] Run full test suite: `go test ./...`
- [ ] Verify all tests pass

### Phase 4: Validation
- [ ] Test in production-like scenario
- [ ] Verify no regressions in other handlers (assetmin, tinywasm, goserver)
- [ ] Check edge cases (empty dirs, missing files)
- [ ] Performance check (no slowdown in file watching)

### Phase 5: Documentation
- [ ] Update `goflare/README.md` if needed
- [ ] Add comments explaining UnobservedFiles logic
- [ ] Document the fix in this file
- [ ] Create commit with detailed message

---

## Additional Notes

### Why This Bug Wasn't Caught Earlier

1. **Missing compilation error:** The non-existent method call should have failed at compile time
   - Possibility: Code path never executed during tests
   - Possibility: Interface satisfaction not validated

2. **No integration tests:** No test validates end-to-end file watching with goflare output

3. **Manual testing only:** golite/example used for manual testing, not automated

### Related Components to Review

1. **goserver/events.go:** Verify `UnobservedFiles()` implementation is correct
2. **tinywasm/file_event.go:** Review existing `UnobservedFiles()` - looks correct
3. **assetmin/events.go:** Review existing `UnobservedFiles()` - looks correct

### Performance Considerations

- Adding 2 strings to unobserved files list: negligible impact
- No additional file I/O required
- Path construction happens once during initialization

---

## Questions for Review

1. **Should we keep using `OutputRelativePath()` from tinywasm or build the path directly?**
   - Current: `h.tw.OutputRelativePath()` works and returns relative path
   - Alternative: `filepath.Join(h.config.RelativeOutputDirectory, h.config.OutputWasmFileName)`

2. **Should we fix `WasmExecJsOutputPath()` to return relative paths (Option 2)?**
   - Would benefit consistency
   - Might break other consumers expecting absolute paths

3. **Why is `DisableWasmExecJsOutput = true` for goflare?**
   - Because wasm_exec.js is embedded inline in `_worker.js`
   - Cloudflare Workers need a single file deployment

4. **Should unobserved files always be relative paths?**
   - Current devwatch logic can handle both but relative is cleaner
   - Mixing types causes confusion and potential matching issues

---

## Recommendation

**Proceed with Option 1 or Option 3** because:
- ✅ Simplest solution (changes only goflare)
- ✅ Uses consistent relative paths
- ✅ Explicitly includes `_worker.js` (the missing file)
- ✅ Self-contained in goflare package
- ✅ Easy to test and verify
- ✅ No breaking changes to tinywasm

**Option 1 vs Option 3:**
- **Option 1**: Fully self-contained, doesn't depend on tinywasm methods
- **Option 3**: Reuses `OutputRelativePath()` but adds missing `_worker.js`

**My preference: Option 3** - Reuses existing working code while fixing the actual issue.

---

**Status:** Awaiting approval before refactoring
**Priority:** High (affects file watching correctness)
**Impact:** Medium (affects deploy section only, not build section)
